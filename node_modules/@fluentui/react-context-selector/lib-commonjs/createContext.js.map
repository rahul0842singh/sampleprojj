{"version":3,"mappings":";;;;;;AAAA;AACA;AACA;AAIA,MAAMA,cAAc,GAAWC,QAA6C,IAAI;EAC9E,MAAMC,QAAQ,GAAyCC,KAAK,IAAG;IAC7D;IACA,MAAMC,QAAQ,GAAGC,KAAK,CAACC,MAAM,CAACH,KAAK,CAACI,KAAK,CAAC;IAC1C;IACA,MAAMC,UAAU,GAAGH,KAAK,CAACC,MAAM,CAAC,CAAC,CAAC;IAElC;IACA,MAAMG,YAAY,GAAGJ,KAAK,CAACC,MAAM,EAAuB;IAExD,IAAI,CAACG,YAAY,CAACC,OAAO,EAAE;MACzBD,YAAY,CAACC,OAAO,GAAG;QACrBH,KAAK,EAAEH,QAAQ;QACfO,OAAO,EAAEH,UAAU;QACnBI,SAAS,EAAE;OACZ;;IAGHC,2CAAyB,CAAC,MAAK;MAC7BT,QAAQ,CAACM,OAAO,GAAGP,KAAK,CAACI,KAAK;MAC9BC,UAAU,CAACE,OAAO,IAAI,CAAC;MAEvBI,oCAAe,CAACA,mCAAc,EAAE,MAAK;QAClCL,YAAY,CAACC,OAA+B,CAACE,SAAS,CAACG,OAAO,CAACC,QAAQ,IAAG;UACzEA,QAAQ,CAAC,CAACR,UAAU,CAACE,OAAO,EAAEP,KAAK,CAACI,KAAK,CAAC,CAAC;QAC7C,CAAC,CAAC;MACJ,CAAC,CAAC;IACJ,CAAC,EAAE,CAACJ,KAAK,CAACI,KAAK,CAAC,CAAC;IAEjB,OAAOF,KAAK,CAACY,aAAa,CAAChB,QAAQ,EAAE;MAAEM,KAAK,EAAEE,YAAY,CAACC;IAAO,CAAE,EAAEP,KAAK,CAACe,QAAQ,CAAC;EACvF,CAAC;EAED;EACA,IAAIC,OAAO,CAACC,GAAG,CAACC,QAAQ,KAAK,YAAY,EAAE;IACzCnB,QAAQ,CAACoB,WAAW,GAAG,0BAA0B;;EAGnD,OAAQpB,QAA2D;AACrE,CAAC;AAED;;;AAGO,MAAMqB,aAAa,GAAWC,YAAmB,IAAoB;EAC1E;EACA,MAAMC,OAAO,GAAGpB,KAAK,CAACkB,aAAa,CAAsB;IACvDhB,KAAK,EAAE;MAAEG,OAAO,EAAEc;IAAY,CAAE;IAChCb,OAAO,EAAE;MAAED,OAAO,EAAE,CAAC;IAAC,CAAE;IACxBE,SAAS,EAAE;GACZ,CAAC;EAEFa,OAAO,CAACvB,QAAQ,GAAGF,cAAc,CAAQyB,OAAO,CAACvB,QAAQ,CAAC;EAE1D;EACA,OAASuB,OAAsC,CAACC,QAAQ;EAExD,OAAQD,OAAqC;AAC/C,CAAC;AAdYE,qBAAa","names":["createProvider","Original","Provider","props","valueRef","React","useRef","value","versionRef","contextValue","current","version","listeners","react_utilities_1","scheduler_1","forEach","listener","createElement","children","process","env","NODE_ENV","displayName","createContext","defaultValue","context","Consumer","exports"],"sourceRoot":"../src/","sources":["packages/react-components/react-context-selector/src/createContext.ts"],"sourcesContent":["import { useIsomorphicLayoutEffect } from '@fluentui/react-utilities';\nimport * as React from 'react';\nimport { unstable_NormalPriority as NormalPriority, unstable_runWithPriority as runWithPriority } from 'scheduler';\n\nimport { Context, ContextValue } from './types';\n\nconst createProvider = <Value>(Original: React.Provider<ContextValue<Value>>) => {\n  const Provider: React.FC<React.ProviderProps<Value>> = props => {\n    // Holds an actual \"props.value\"\n    const valueRef = React.useRef(props.value);\n    // Used to sync context updates and avoid stale values, can be considered as render/effect counter of Provider.\n    const versionRef = React.useRef(0);\n\n    // A stable object, is used to avoid context updates via mutation of its values.\n    const contextValue = React.useRef<ContextValue<Value>>();\n\n    if (!contextValue.current) {\n      contextValue.current = {\n        value: valueRef,\n        version: versionRef,\n        listeners: [],\n      };\n    }\n\n    useIsomorphicLayoutEffect(() => {\n      valueRef.current = props.value;\n      versionRef.current += 1;\n\n      runWithPriority(NormalPriority, () => {\n        (contextValue.current as ContextValue<Value>).listeners.forEach(listener => {\n          listener([versionRef.current, props.value]);\n        });\n      });\n    }, [props.value]);\n\n    return React.createElement(Original, { value: contextValue.current }, props.children);\n  };\n\n  /* istanbul ignore else */\n  if (process.env.NODE_ENV !== 'production') {\n    Provider.displayName = 'ContextSelector.Provider';\n  }\n\n  return (Provider as unknown) as React.Provider<ContextValue<Value>>;\n};\n\n/**\n * @internal\n */\nexport const createContext = <Value>(defaultValue: Value): Context<Value> => {\n  // eslint-disable-next-line @fluentui/no-context-default-value\n  const context = React.createContext<ContextValue<Value>>({\n    value: { current: defaultValue },\n    version: { current: -1 },\n    listeners: [],\n  });\n\n  context.Provider = createProvider<Value>(context.Provider);\n\n  // We don't support Consumer API\n  delete ((context as unknown) as Context<Value>).Consumer;\n\n  return (context as unknown) as Context<Value>;\n};\n"]}